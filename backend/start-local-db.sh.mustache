#!/bin/bash

# Start local database for {{{projectName}}}
# This script starts the database using docker-compose

set -e

echo "🚀 Starting local database for {{{projectName}}}..."

# Check if docker is running
if ! docker info > /dev/null 2>&1; then
    echo "❌ Docker is not running. Please start Docker and try again."
    exit 1
fi

# Start docker-compose
docker-compose up -d

# Wait for database to be ready
echo "⏳ Waiting for database to be ready..."
sleep 5

# Check health
{{#isPostgreSQL}}
until docker exec {{{projectName}}}-postgres pg_isready -U {{{projectName}}}_user > /dev/null 2>&1; do
    echo "   Database is not ready yet... waiting"
    sleep 2
done
{{/isPostgreSQL}}
{{#isMySQL}}
until docker exec {{{projectName}}}-mysql mysqladmin ping -h localhost > /dev/null 2>&1; do
    echo "   Database is not ready yet... waiting"
    sleep 2
done
{{/isMySQL}}
{{#isMariaDB}}
until docker exec {{{projectName}}}-mariadb mysqladmin ping -h localhost > /dev/null 2>&1; do
    echo "   Database is not ready yet... waiting"
    sleep 2
done
{{/isMariaDB}}

echo "✅ Database is ready!"
echo ""
echo "Database connection details:"
{{#isPostgreSQL}}
echo "   Host: localhost"
echo "   Port: 5432"
echo "   Database: {{{projectName}}}"
echo "   Username: {{{projectName}}}_user"
echo "   Password: devpassword"
echo ""
echo "Connect: psql -h localhost -U {{{projectName}}}_user -d {{{projectName}}}"
{{/isPostgreSQL}}
{{#isMySQL}}
echo "   Host: localhost"
echo "   Port: 3306"
echo "   Database: {{{projectName}}}"
echo "   Username: {{{projectName}}}_user"
echo "   Password: devpassword"
echo ""
echo "Connect: mysql -h localhost -u {{{projectName}}}_user -p{{{projectName}}}"
{{/isMySQL}}
{{#isMariaDB}}
echo "   Host: localhost"
echo "   Port: 3306"
echo "   Database: {{{projectName}}}"
echo "   Username: {{{projectName}}}_user"
echo "   Password: devpassword"
echo ""
echo "Connect: mysql -h localhost -u {{{projectName}}}_user -p{{{projectName}}}"
{{/isMariaDB}}
echo ""
echo "To stop the database: docker-compose down"
echo "To view logs: docker-compose logs -f"
